<html>
<header>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/colorbrewer.v1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.min.js" integrity="sha512-wNH6xsp2n8CfB91nrBtfc4sfLwYPBMjSWVUwQOp60AYYXH6i8yCwuKFZ4rgK2i6pQek/b+bSyR7b01/922IBzQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</header>
<body>
<script>
    var nodeSet = new Set()
    var nodes = []

    //dimensions for svg using margin object to access instance vars
    var margin = {top: 30, bottom: 30, left: 30, right: 30};
    var width = 600 - margin.right - margin.left;
    var height = 300 - margin.top - margin.bottom;

    var svg = d3.select("body")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    //create color scale!
    var color = () => {
        const scale = d3.scaleOrdinal(d3.schemeCategory10);
        return d => scale(d.group);
    }

    d3.csv("https://gist.githubusercontent.com/simonalt/62de86874fed4e4951adc49f6f24faaa/raw/0d3e380fc7cad4f7c1d465c8925fc39f89ca7888/soc-firm-hi-tech.csv", function(d){
        //map column names to source, target, and value var names
        return{
            source: d['id1'],
            target: d['id2'],
            value: d['lines']
        }
    }).then(data => {
        const links = data
        //loop through each object and add to nodeSet and node array
        links.forEach( d => {
            if(!nodeSet.has(d.source)){
                nodeSet.add(d.source)
                nodes.push({id: d.source})
            }
            if(!nodeSet.has(d.target)){
                nodeSet.add(d.target)
                nodes.push({id: d.target})
            }
        });

        const scale = d3.scaleOrdinal(d3.schemeCategory10);
        //create simulation for force directed layout
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id))
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2));

        //append svg to body
        const svg = d3.select("body")
            .append("svg")
            .attr("width", width)
            .attr("height", height)

        //create links for diagram from links var
        const link = svg.append("g")
            .attr("stroke", "#999")
            .attr("stroke-opacity", 0.6)
            .selectAll("line")
            .data(links)
            .join("line")
            .attr("stroke-width", d => Math.sqrt(d.value));

        //create nodes for diagram from nodes array
        const node = svg.append("g")
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5)
            .selectAll("circle")
            .data(nodes)
            .join("circle")
            .attr("r", 6)
            .attr("fill", function(d){
                return scale(d.id)
            })

        //act on the changed layout and draw the nodes and links from where they currently are in the sim
        simulation.on("tick", () => {
            link //calc link on each tick
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node //calc node on each tick
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
        });
    })
</script>
</body>
</html>